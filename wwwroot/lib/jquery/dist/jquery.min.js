$(document).ready(function () {
    $('#Entrar').submit(function() {
        var password = $('#UsPasswrd').val();
        if (!password) {
            alert('Por favor, ingrese una contraseña.');
            event.preventDefault();
        }
    });

    // Solo ejecuta el script si el contenedor est� presente
    $('#peAnio').change(function () {
        var peAnio = $(this).val();
        //console.log('A�o seleccionado:', peAnio);
        $('#peTipo').empty().append('<option value="">TIPO</option>').prop('disabled', true);
        $('#teNumeroPeriodo').empty().append('<option value="">NUMERO</option>').prop('disabled', true);

        if (peAnio) {
            $.getJSON('/Home/GetPeTipos', {
                peAnio: peAnio
            }, function (data) {
                $('#peTipo').prop('disabled', false);
                $.each(data, function (index, value) {
                    $('#peTipo').append('<option value="' + value + '">' + value + '</option>');
                });
            });
        }
    });

    $('#peTipo').change(function () {
        var peTipo = $(this).val();
        var peAnio = $('#peAnio').val(); // Obt�n el A�o seleccionado

        $('#teNumeroPeriodo').empty().append('<option value="">NUMERO</option>').prop('disabled', true);

        if (peTipo) {
            $.getJSON('/Home/GetTeNumeroPeriodos',
                {
                    peAnio: peAnio,
                    peTipo: peTipo
                }, function (data) {
                    $('#teNumeroPeriodo').prop('disabled', false);
                    $.each(data, function (index, value) {
                        $('#teNumeroPeriodo').append('<option value="' + value + '">' + value + '</option>');
                    });
                });
        }
    });

    // Manejo de seleccion de filas
    $('#rowSelect').on('click', '.select-row', function () {
        // Añade la clase a la fila seleccionada
        $(this).closest('tr').addClass('selected-row');
    
        // Obtén los datos de la fila seleccionada
        var selectedData = $(this).closest('tr').children('td').map(function () {
            return $(this).text();
        }).get();
    
        var peTipo = $('#peTipo').val();
        var peAnio = $('#peAnio').val();
        var peNumero = $('#teNumeroPeriodo').val();
    
        if (peNumero) {
            $.ajax({
                url: '/Home/CreateReports', // Endpoint del servidor para crear el reporte
                type: 'GET', // Método HTTP
                data: {
                    ReCodigo: selectedData[0],
                    ReNombre: selectedData[1],
                    peAnio: peAnio,
                    peTipo: peTipo,
                    peNumero: peNumero,
                    Activo: true
                },
                success: function (response) {
                    // Verifica si la respuesta contiene el publicPath
                    var publicPath = response.publicPath;
                    if (response) 
                    {
                        // Abre el PDF en una nueva ventana
                        $.ajax({
                            url: '/Home/ViewReports',
                            type: 'GET',
                            data: { publicPath: publicPath },
                            success: function () {
                                console.log('Reporte generado correctamente: ' + publicPath);
                                // Redirige a la vista para visualizar el reporte

                                window.location.href = '/Home/ViewReports?publicPath=' + publicPath;
                            },
                            error: function (xhr, status, error) {
                                console.error("Error al visualizar el reporte:", error);
                                alert("Ocurrió un error al visualizar el reporte.");
                            }
                        });
                    } 
                    else {
                        console.error("No se encontró el publicPath en la respuesta.");
                        alert("Ocurrió un error al generar el reporte.");
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Error al crear el reporte:", error);
                    alert("Ocurrió un error al generar el reporte.");
                }
            });
        } else {
            console.error('No se seleccionó un número de periodo.');
            alert("Por favor selecciona un número de periodo válido.");
        }
    });

    $(document).ready(function () {
        $('#rowSelect').DataTable({
            "pageLength": 10,
            "lengthChange": false,
            "language": {
                "paginate": {
                    "previous": "Anterior",
                    "next": "Siguiente"
                },
                "info": "Mostrando _START_ a _END_ de _TOTAL_ reportes",
                "infoEmpty": "Mostrando 0 a 0 de 0 reportes",
                "emptyTable": "No hay datos disponibles en la tabla",
                "search": "Buscar:"
            }
        });
    });
});