$(document).ready(function () {
    $('#Entrar').submit(function () {
        var password = $('#UsPasswrd').val();
        if (!password) {
            alert('Por favor, ingrese una contraseña.');
            event.preventDefault();
        }
    });

    // Solo ejecuta el script si el contenedor est� presente
    $('#peAnio').change(function () {
        var peAnio = $(this).val();
        //console.log('A�o seleccionado:', peAnio);
        $('#peTipo').empty().append('<option value="">TIPO</option>').prop('disabled', true);
        $('#teNumeroPeriodo').empty().append('<option value="">NUMERO</option>').prop('disabled', true);

        if (peAnio) {
            $.getJSON('/Home/GetPeTipos', {
                peAnio: peAnio
            }, function (data) {
                $('#peTipo').prop('disabled', false);
                $.each(data, function (index, value) {
                    $('#peTipo').append('<option value="' + value + '">' + value + '</option>');
                });
            });
        }
    });

    $('#peTipo').change(function () {
        var peTipo = $(this).val();
        var peAnio = $('#peAnio').val(); // Obt�n el A�o seleccionado

        $('#teNumeroPeriodo').empty().append('<option value="">NUMERO</option>').prop('disabled', true);

        if (peTipo) {
            $.getJSON('/Home/GetTeNumeroPeriodos',
                {
                    peAnio: peAnio,
                    peTipo: peTipo
                }, function (data) {
                    $('#teNumeroPeriodo').prop('disabled', false);
                    $.each(data, function (index, value) {
                        $('#teNumeroPeriodo').append('<option value="' + value + '">' + value + '</option>');
                    });
                });
        }
    });

    $('#rowSelect').on('click', '.download-row', function () {
        // Añade la clase a la fila seleccionada
        $(this).closest('tr').addClass('selected-row');

        // Obtén los datos de la fila seleccionada
        var selectedData = $(this).closest('tr').children('td').map(function () {
            return $(this).text();
        }).get();

        var peTipo = $('#peTipo').val();
        var peAnio = $('#peAnio').val();
        var peNumero = $('#teNumeroPeriodo').val();
        if (peNumero) {
            showModal();
            $.ajax({                
                url: '/Home/DownloadReports',
                type: 'GET',
                data: {
                    ReCodigo: selectedData[0],
                    ReNombre: selectedData[1],
                    peAnio: peAnio,
                    peTipo: peTipo,
                    peNumero: peNumero,
                    Activo: true
                },
                xhrFields: {
                    responseType: 'blob' // Maneja la respuesta como un archivo binario
                },
                success: function (data, status, xhr) {
                    // Crear un enlace para descargar el archivo
                    var blob = new Blob([data], { type: 'application/pdf' });
                    var url = window.URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;

                    // Opcional: Obtener el nombre del archivo del encabezado
                    var filename = xhr.getResponseHeader('Content-Disposition')?.split('filename=')[1] || 'reporte.pdf';
                    a.download = filename.replace(/['"]/g, ''); // Elimina comillas si existen

                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);

                    alert("Reporte generado correctamente.");
                },
                error: function (xhr, status, error) {
                    console.error("Error al crear el reporte:", error);
                    alert("Ocurrió un error al generar el reporte.");
                },
                complete: function () {
                    // Oculta el modal de carga
                    hideModal();
                }
            });
        } else {
            console.error('No se seleccionó un número de periodo.');
            alert("Por favor selecciona un número de periodo válido.");
            hideModal();
        }
    });

    $('#rowSelect').on('click', '.excel-row', function () {
        // Añade la clase a la fila seleccionada
        $(this).closest('tr').addClass('selected-row');

        // Obtén los datos de la fila seleccionada
        var selectedData = $(this).closest('tr').children('td').map(function () {
            return $(this).text();
        }).get();

        var peTipo = $('#peTipo').val();
        var peAnio = $('#peAnio').val();
        var peNumero = $('#teNumeroPeriodo').val();
        if (peNumero) {
            showModal();
            $.ajax({
                url: '/Home/ExcelReports',
                type: 'GET',
                data: {
                    ReCodigo: selectedData[0],
                    ReNombre: selectedData[1],
                    peAnio: peAnio,
                    peTipo: peTipo,
                    peNumero: peNumero,
                    Activo: true
                },
                xhrFields: {
                    responseType: 'blob' // Maneja la respuesta como un archivo binario
                },
                success: function (data, status, xhr) {
                    // Crear un enlace para descargar el archivo
                    var blob = new Blob([data], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    var url = window.URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;

                    // Opcional: Obtener el nombre del archivo del encabezado
                    var filename = xhr.getResponseHeader('Content-Disposition')?.split('filename=')[1] || 'reporte.xls';
                    a.download = filename.replace(/['"]/g, ''); // Elimina comillas si existen

                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);

                    alert("Reporte generado correctamente.");
                },
                error: function (xhr, status, error) {
                    console.error("Error al crear el reporte:", error);
                    alert("Ocurrió un error al generar el reporte.");
                },
                complete: function () {
                    // Oculta el modal de carga
                    hideModal();
                }
            });
        } else {
            console.error('No se seleccionó un número de periodo.');
            alert("Por favor selecciona un número de periodo válido.");
            hideModal();
        }
    });

    // Manejo de seleccion de filas
    $('#rowSelect').on('click', '.select-row', function () {
        $(this).closest('tr').addClass('selected-row');

        var selectedData = $(this).closest('tr').children('td').map(function () {
            return $(this).text();
        }).get();

        var peTipo = $('#peTipo').val();
        var peAnio = $('#peAnio').val();
        var peNumero = $('#teNumeroPeriodo').val();

        if (peNumero) {
            // Muestra el modal de carga
            showModal();

            $.ajax({
                url: '/Home/CreateReports',
                type: 'GET',
                data: {
                    ReCodigo: selectedData[0],
                    ReNombre: selectedData[1],
                    peAnio: peAnio,
                    peTipo: peTipo,
                    peNumero: peNumero,
                    Activo: true
                },
                success: function (response) {
                    var path = response.trim();

                    if (path) {
                        $.ajax({
                            url: '/Home/ViewReports',
                            type: 'GET',
                            data: { publicPath: path },
                            success: function () {
                                console.log('Reporte generado correctamente: ' + path);
                                window.location.href = '/Home/ViewReports?publicPath=' + path;
                            },
                            error: function (xhr, status, error) {
                                console.error("Error al visualizar el reporte:", error);
                                alert("Ocurrió un error al visualizar el reporte.");
                            },
                            complete: function () {
                                // Oculta el modal de carga
                                hideModal();
                            }
                        });
                    } else {
                        console.error("La respuesta no contiene la ruta del archivo.");
                        alert("Ocurrió un error al generar el reporte.");
                        hideModal();
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Error al crear el reporte:", error);
                    alert("Ocurrió un error al generar el reporte.");
                    hideModal();
                }
            });
        } else {
            console.error('No se seleccionó un número de periodo.');
            alert("Por favor selecciona un número de periodo válido.");
        }
    });

    $('#nominas').on('click', function () {
        var peTipo = $('#peTipo').val();
        var peAnio = $('#peAnio').val();
        var peNumero = $('#teNumeroPeriodo').val();

        if (!peNumero) {
            alert("Por favor selecciona un número de periodo válido.");
            return;
        }

        showModal(); // opcional, si tienes un spinner o algo visual

        $.ajax({
            url: '/Home/NominaView',
            type: 'GET',
            data: {
                peAnio: peAnio,
                peTipo: peTipo,
                peNumero: peNumero
            },
            success: function (data) {
                if (data) {
                    $('input[name="periodoInicio"]').val(data.CbSalario);
                    $('input[name="periodoFin"]').val(data.PeriodoFin);
                    $('input[name="asistenciaInicio"]').val(data.CbSalario);
                    $('input[name="asistenciaFin"]').val(data.PeriodoFin);
                    $('input[name="estado"]').val(data.Estado);
                    $('input[name="descripcion"]').val(data.Descripcion);
                    $('input[name="percepcion"]').val(data.Percepcion);
                    $('input[name="deduccion"]').val(data.Deduccion);
                    $('input[name="neto"]').val(data.Neto);
                    $('input[name="empleados"]').val(data.Empleados);
                    $('input[name="fecha"]').val(data.Fecha);
                } else {
                    alert("No se encontró información para los parámetros seleccionados.");
                }
                
            },
            error: function (xhr, status, error) {
                console.error("Error al visualizar el reporte:", error);
                alert("Ocurrió un error al visualizar el reporte.");
            },
            complete: function () {
                hideModal(); // oculta el modal de carga
            }
        });
    });

    $(document).ready(function () {
        $('#rowSelect').DataTable({
            "pageLength": 10,
            "lengthChange": false,
            "language": {
                "paginate": {
                    "previous": "Anterior",
                    "next": "Siguiente"
                },
                "info": "Mostrando _START_ a _END_ de _TOTAL_ reportes",
                "infoEmpty": "Mostrando 0 a 0 de 0 reportes",
                "emptyTable": "No hay datos disponibles en la tabla",
                "search": "Buscar: "
            }
        });
    });

    

    // Funciones para mostrar y ocultar el modal
    function showModal() {
        loadingModal.classList.remove('hidden');
    }

    function hideModal() {
        loadingModal.classList.add('hidden');
    }

});